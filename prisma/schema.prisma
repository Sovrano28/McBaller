// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  type        String   // "club" | "team" | "agent"
  email       String
  phone       String?
  address     String?
  logo        String?
  website     String?
  description String?
  settings    Json?    // Flexible settings storage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teams       Team[]
  users       User[]
  players     Player[]
  contracts   Contract[]
  invoices    Invoice[]

  @@index([slug])
  @@index([type])
  @@map("organizations")
}

model Team {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  slug           String
  logo           String?
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contracts      Contract[]
  players        Player[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@map("teams")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  passwordHash   String
  role           String   // "player" | "org_admin" | "coach" | "finance" | "analyst"
  organizationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lastLoginAt    DateTime?

  // Relations
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  player         Player?

  @@index([email])
  @@index([organizationId])
  @@index([role])
  @@map("users")
}

model Player {
  id                String   @id @default(cuid())
  userId            String   @unique
  name              String
  username          String   @unique
  phone             String
  avatar            String?
  dateOfBirth       DateTime?
  state             String?
  currentLocation   String?
  position          String   // "Goalkeeper" | "Defender" | "Midfielder" | "Forward"
  preferredFoot     String?  // "Left" | "Right" | "Both"
  height            Int?
  weight            Int?
  bio               String?
  socialMedia       Json?    // {instagram?, twitter?, facebook?}
  subscriptionTier  String   @default("free") // "free" | "pro" | "elite"
  subscriptionExpiry DateTime?
  trialUsed         Boolean  @default(false)
  trainingCompleted Json?    // Array of training program IDs: ["1", "3", "5"]
  badges            Json?    // Array of badge names: ["complete_profile", "week_streak"]
  joinedAt          DateTime @default(now())
  
  // Organization Relations (nullable for independent players)
  organizationId    String?
  teamId            String?  // Current team assignment (one team only)

  // Relations
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  team              Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
  contracts         Contract[]
  invoices          Invoice[]
  leagueStats       LeagueStat[]
  trainingProgress  TrainingProgress[]
  posts             Post[]

  @@index([username])
  @@index([organizationId])
  @@index([teamId])
  @@index([subscriptionTier])
  @@map("players")
}

model LeagueStat {
  id            String   @id @default(cuid())
  playerId      String
  season        String
  club          String
  appearances   Int      @default(0)
  goals         Int      @default(0)
  assists       Int      @default(0)
  yellowCards   Int      @default(0)
  redCards      Int      @default(0)
  verified      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  player        Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, season, club])
  @@index([playerId])
  @@index([season])
  @@map("league_stats")
}

model Contract {
  id             String   @id @default(cuid())
  playerId       String
  organizationId String
  teamId         String?
  startDate      DateTime
  endDate        DateTime?
  salary         Decimal? @db.Decimal(12, 2)
  terms          Json?    // Structured contract terms
  status         String   @default("active") // "active" | "expired" | "terminated"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  player         Player       @relation(fields: [playerId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  team           Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@index([playerId])
  @@index([organizationId])
  @@index([status])
  @@map("contracts")
}

model Invoice {
  id             String   @id @default(cuid())
  organizationId String
  playerId       String?
  invoiceNumber  String   @unique
  amount         Decimal  @db.Decimal(12, 2)
  currency       String   @default("NGN")
  status         String   @default("draft") // "draft" | "sent" | "paid" | "overdue" | "void"
  dueDate        DateTime
  paidAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  player         Player?      @relation(fields: [playerId], references: [id], onDelete: SetNull)
  payments       Payment[]

  @@index([organizationId])
  @@index([playerId])
  @@index([status])
  @@index([invoiceNumber])
  @@map("invoices")
}

model Payment {
  id            String   @id @default(cuid())
  invoiceId     String
  amount        Decimal  @db.Decimal(12, 2)
  method        String   // "paystack" | "bank_transfer" | "mobile_money" | "cash"
  status        String   @default("pending") // "pending" | "succeeded" | "failed" | "refunded"
  transactionId String?
  paidAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  invoice       Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([invoiceId])
  @@index([status])
  @@index([transactionId])
  @@map("payments")
}

model Transaction {
  id        String   @id @default(cuid())
  paymentId String
  type      String   // "payment" | "refund" | "adjustment"
  amount    Decimal  @db.Decimal(12, 2)
  status    String   // "pending" | "completed" | "failed"
  metadata  Json?    // Flexible storage for payment gateway responses
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@map("transactions")
}

model TrainingProgress {
  id                String   @id @default(cuid())
  playerId          String
  trainingProgramId String   // References training program ID from mock data
  status            String   @default("in_progress") // "not_started" | "in_progress" | "completed"
  progressPercent   Int      @default(0)
  completedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  player            Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, trainingProgramId])
  @@index([playerId])
  @@map("training_progress")
}

model Post {
  id        String   @id @default(cuid())
  playerId  String
  content   String
  mediaType String?  // "image" | "video" | null
  mediaUrl  String?
  likes     Int      @default(0)
  comments  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@index([playerId])
  @@index([createdAt])
  @@map("posts")
}

